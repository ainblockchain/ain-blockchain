{
  ".write": false,
  "accounts": {
    "$user_addr": {
      "balance": {
        ".write": "auth.fid === '_transfer'"
      }
    }
  },
  "checkin": {
    "$user_addr": {
      "$checkin_id": {
        "request": {
          ".write": "data === null && auth.addr === $user_addr && util.isDict(newData)"
        },
        "parent_finalize": {
          "$tx_hash": {
            "result": {
              ".write": "auth.addr === getValue('/sharding/config/shard_owner') && util.isBool(newData)"
            }
          }
        }
      }
    }
  },
  "consensus": {
    "number": {
      "$number": {
        ".write": "newData === null && !!getValue('/consensus/number/' + (Number($number) + 1000))",
        "propose": {
          ".write": "newData !== null && util.isDict(newData) && newData.proposer === auth.addr && Number($number) === newData.number && getValue('/consensus/whitelist/' + auth.addr) === true && (lastBlockNumber < 1 || getValue('/service_accounts/staking/consensus/' + auth.addr + '|0/balance') >= util.getMinStakeAmount())"
        },
        "vote": {
          "$user_addr": {
            ".write": "auth.addr === $user_addr && util.isDict(newData) && util.isString(newData.block_hash) && util.isNumber(newData.stake) && newData.stake > 0 && getValue('/consensus/whitelist/' + auth.addr) === true && (lastBlockNumber < 1 || getValue('/service_accounts/staking/consensus/' + auth.addr + '|0/balance') >= util.getMinStakeAmount())"
          }
        }
      }
    },
    "whitelist": {
      "$user_addr": {
        ".write": "auth.addr === util.getOwnerAddr() && (newData === true || (newData === null && util.length(util.values(getValue('/consensus/whitelist')).filter(x => x === true)) > util.getMinNumValidators()))"
      }
    }
  },
  "escrow": {
    "$source_account": {
      "$target_account": {
        "$escrow_key": {
          "hold": {
            "$record_id": {
              ".write": "((util.isServAcntName($source_account) && getValue(util.getServAcntAdminPath($source_account) + '/' + auth.addr) === true) || (util.isCksumAddr($source_account) && $source_account === auth.addr)) && getValue(util.getServAcntAdminPath(util.toServiceAccountName('escrow', 'escrow', util.toEscrowAccountName($source_account, $target_account, $escrow_key)))) !== null && data === null && util.isDict(newData)",
              "result": {
                ".write": "auth.fid === '_hold'"
              }
            }
          },
          "open": {
            ".write": "util.isCksumAddr(auth.addr) && data === null && util.isDict(newData) && util.isDict(newData.admin) && Object.entries(newData.admin).every(([k, v]) => util.isCksumAddr(k) && v === true) && (util.isCksumAddr($source_account) || util.isServAcntName($source_account)) && (util.isCksumAddr($target_account) || util.isServAcntName($target_account))"
          },
          "release": {
            "$record_id": {
              ".write": "getValue(util.getServAcntAdminPath(util.toServiceAccountName('escrow', 'escrow', util.toEscrowAccountName($source_account, $target_account, $escrow_key))) + '/' + auth.addr) === true && data === null && util.isDict(newData) && util.isNumber(newData.ratio) && 0 <= newData.ratio && newData.ratio <= 1",
              "result": {
                ".write": "auth.fid === '_release'"
              }
            }
          }
        }
      }
    }
  },
  "manage_app": {
    "$app_name": {
      "config": {
        ".write": "auth.fid === '_createApp' || getValue('/manage_app/' + $app_name + '/config/admin/' + auth.addr) === true"
      },
      "create": {
        "$record_id": {
          ".write": "data === null && getValue('/manage_app/' + $app_name + '/config') === null && util.isDict(newData)",
          "result": {
            ".write": "auth.fid === '_createApp'"
          }
        }
      }
    }
  },
  "payments": {
    "$service_name": {
      "config": {
        "admin": {
          "$admin_addr": {
            ".write": "evalOwner('/payments/' + $service_name + '/config', 'write_owner', auth) && (newData === true || newData === null)"
          }
        }
      },
      "$user_addr": {
        "$payment_key": {
          "claim": {
            "$record_id": {
              ".write": "getValue('/payments/' + $service_name + '/config/admin/' + auth.addr) === true && data === null && newData !== null && util.isNumber(newData.amount) && newData.amount > 0 && (util.isCksumAddr(newData.target) || util.isServAcntName(newData.target))",
              "result": {
                ".write": "auth.fid === '_claim'"
              }
            }
          },
          "pay": {
            "$record_id": {
              ".write": "getValue('/payments/' + $service_name + '/config/admin/' + auth.addr) === true && data === null && newData !== null && util.isNumber(newData.amount) && newData.amount > 0",
              "result": {
                ".write": "auth.fid === '_pay'"
              }
            }
          }
        }
      }
    }
  },
  "service_accounts": {
    "$service_type": {
      "$service_name": {
        "$key": {
          ".write": "auth.fid === '_openEscrow'",
          "admin": {
            "$admin_addr": {
              ".write": "auth.fid === '_transfer' || auth.fid === '_stake' || auth.fid === '_unstake' || auth.fid === '_pay' || auth.fid === '_claim'"
            }
          },
          "balance": {
            ".write": "auth.fid === '_transfer'"
          }
        }
      }
    }
  },
  "sharding": {
    "shard": {
      ".write": false,
      "$sharding_path": {
        ".write": "(data === null && util.isDict(newData) && util.isString(newData.sharding_path) && util.isString(newData.parent_chain_poc) && util.isNumber(newData.reporting_period) && util.isValAddr(newData.shard_owner) && util.isValAddr(newData.shard_reporter) && util.isValShardProto(newData.sharding_protocol) && evalOwner(newData.sharding_path, 'write_owner', auth) && evalOwner(newData.sharding_path, 'write_rule', auth) && evalOwner(newData.sharding_path, 'write_function', auth)) || (auth.addr === data.shard_owner && newData === null)"
      }
    }
  },
  "staking": {
    "$service_name": {
      "balance_total": {
        ".write": "auth.fid === '_stake' || auth.fid === '_unstake'"
      },
      "$user_addr": {
        "$staking_key": {
          "expire_at": {
            ".write": "auth.fid === '_stake'"
          },
          "stake": {
            "$record_id": {
              "value": {
                ".write": "$user_addr === auth.addr && data === null && util.isNumber(newData) && newData >= 0 && getValue('/accounts/' + $user_addr + '/balance') >= newData"
              },
              "result": {
                ".write": "auth.fid === '_stake'"
              }
            }
          },
          "unstake": {
            "$record_id": {
              "value": {
                ".write": "$user_addr === auth.addr && data === null && util.isNumber(newData) && newData > 0 && newData <= getValue(util.getBalancePath(util.toServiceAccountName('staking', $service_name, $user_addr + '|' + $staking_key)))"
              },
              "result": {
                ".write": "auth.fid === '_unstake'"
              }
            }
          }
        }
      }
    }
  },
  "transfer": {
    "$from": {
      "$to": {
        "$key": {
          "value": {
            ".write": "(auth.addr === $from || auth.fid === '_stake' || auth.fid === '_unstake' || auth.fid === '_pay' || auth.fid === '_claim' || auth.fid === '_hold' || auth.fid === '_release') && !getValue('transfer/' + $from + '/' + $to + '/' + $key) && (util.isServAcntName($from) || util.isCksumAddr($from)) && (util.isServAcntName($to) || util.isCksumAddr($to)) && $from !== $to && util.isNumber(newData) && getValue(util.getBalancePath($from)) >= newData"
          },
          "result": {
            ".write": "auth.fid === '_transfer'"
          }
        }
      }
    }
  }
}
